name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - api
          - e2e
          - all

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[dev]

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps

      - name: Run tests via Makefile
        env:
          TEST_ENV: ${{ github.event.inputs.environment || 'staging' }}
          TEST_TYPE: ${{ github.event.inputs.test_type || 'all' }}
        run: |
          mkdir -p reports/html reports/allure reports/playwright-html reports/screenshots
          echo "Running tests: type=${TEST_TYPE}, env=${TEST_ENV}"
          # Forward pytest --env via PYTEST_ADDOPTS so Makefile pytest commands pick it up
          case "${TEST_TYPE}" in
            api)
              PYTEST_ADDOPTS="--env=${TEST_ENV}" PYTHON=$(which python) make test-api
              ;;
            e2e)
              PYTEST_ADDOPTS="--env=${TEST_ENV}" PYTHON=$(which python) make test-e2e
              ;;
            all)
              PYTEST_ADDOPTS="--env=${TEST_ENV}" PYTHON=$(which python) make test
              ;;
            *)
              echo "Unknown test_type: ${TEST_TYPE} -- expected api|e2e|all"; exit 1 ;;
          esac

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            reports/html
            reports/allure
            reports/playwright-html
            reports/screenshots
